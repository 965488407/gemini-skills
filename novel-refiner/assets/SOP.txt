# 小说精炼Agent SOP (v5.0 - 情绪曲线增强版)

> 基于"剧情状态机"的**视频解说文案**生成流程。
> 核心目标：将网文转化为**口语化、低门槛、强节奏、有情绪起伏**的第三人称解说文案。

---

## 文件结构

```
├── story_context.txt         # 核心状态表（运行时生成/更新）
├── .gemini/skills/novel-refiner/
│   ├── SKILL.md              # Skill 入口文件
│   ├── assets/               # 核心配置与模板
│   │   ├── 小说精炼提示词.txt  # v5.0 含情绪节拍+金句系统
│   │   ├── 剧情块提示词.txt    # v5.0 含情绪曲线+预知式钩子
│   │   ├── 设定提取提示词.txt
│   │   ├── story_context_template.txt
│   │   └── SOP.txt
│   └── scripts/
│       └── novel_refiner.py  # 主脚本
├── 小说原文/                 # 用户放入新书原文
├── 剧情块/                   # 运行时生成的规划（含情绪曲线）
├── 精炼成品/                 # 最终输出的文案
└── _archive/                 # 历史备份
```

---

## 流程总览

```
┌─────────────────────────────────────────────────────────┐
│  Phase 0: 初始化 (新书一次)                              │
│  使用 reset_project.ps1 清理环境 → 放入新书 → 自动提取设定 │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│  Phase 1: 规划 (按需执行) [v5.0 增强]                    │
│  读取原文 → 生成剧情块规划                               │
│  新增：情绪曲线分析 + 预知式剧透钩子                      │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│  Phase 2: 循环执行 [v5.0 增强]                           │
│                                                         │
│  ┌──────────────┐    ┌──────────┐                      │
│  │ 视频文案生成 │ → │ 状态更新 │ → 下一块               │
│  │ (情绪节拍)   │    │          │                      │
│  │ (金句系统)   │    │          │                      │
│  └──────────────┘    └──────────┘                      │
└─────────────────────────────────────────────────────────┘
```


---

## Phase 0: 初始化

### Step 0.1: 环境准备
1. 运行 `reset_project.ps1` 脚本，备份旧项目并清理环境。
2. 将新书的 `.txt` 文件放入 `小说原文/` 文件夹。

### Step 0.2: 设定提取与建档
1. **Agent执行**：读取 `小说原文` 前3-5章。
2. **工具调用**：使用 `assets/设定提取提示词.txt`。
3. **建档**：读取 `assets/story_context_template.txt`，将提取的信息填入，保存为根目录下的 `story_context.txt`。

---

## Phase 1: 规划（批量切分）[v5.0 增强]

**触发条件**：待处理队列为空，或进入新卷

1. 使用 `assets/剧情块提示词.txt` (v5.0)
2. 输入：接下来 50 章原文
3. **新增分析**：
   - 情绪曲线类型（压抑→爆发/平稳推进/高潮持续/低谷蓄力/反转冲击/层层递进）
   - 情绪强度标注（起点和终点，1-5分）
   - 预知式剧透钩子（从后续章节提取反转点）
4. 输出：`剧情块/规划_B{N}_第{X}-{Y}章.txt`

**输出格式示例**：
```json
{
  "block_id": "B1",
  "range": "1-8",
  "emotion_curve": {
    "type": "压抑→爆发",
    "start_intensity": 2,
    "end_intensity": 5,
    "turning_point": "第6章主角觉醒"
  },
  "foreshadow_hook": {
    "spoiler": "这个看似普通的选择，三天后会让他失去最重要的人",
    "suspense_point": "谁会死？怎么死的？",
    "source_chapter": "第15章"
  }
}
```

---

## Phase 2: 循环（核心生产）[v5.0 增强]

**⚠️ 重要：每次循环只处理一个剧情块！**

处理流程：
1. 查看 `story_context.txt` 中的 `current_block` 值
2. 从待处理队列中取出对应的剧情块文件
3. 只精炼这一个块，生成一个独立的文案文件
4. 更新状态，然后再处理下一个块

### Step 1: 视频文案生成 (Refining)

1. **读取**：
   - `story_context.txt` (关注 `current_block` 字段确定当前处理哪个块)
   - 当前剧情块规划（含情绪曲线和预知式钩子）
   - 对应原文
2. **执行**：使用 `assets/小说精炼提示词.txt` (v5.0)
   - **⚠️ 单块约束**：每次只处理一个剧情块，不要一次性处理多个！
   - **核心要求**：
     - **视角**：第三人称 (上帝视角)。
     - **语气**：接地气的说书人/博主，像跟朋友聊天。
     - **风格**：大白话，多吐槽，禁止文绉绉。
   - **v5.0 新增要求**：
     - **情绪节拍**：根据情绪曲线类型选择叙事结构
     - **金句系统**：标准块≥2个，高密度块≥3个，每个≤20字
     - **预知式钩子**：禁止疑问句，使用剧透式钩子
3. **保存**：`精炼成品/精炼_B{N}_第{X}-{Y}章.txt`（每个块一个独立文件）

### Step 2: 状态更新 (Update)

1. 更新 `story_context.txt`：
   - 【当前进度】：更新为刚完成的章节
   - 【即时悬念】：**非常重要**，作为下一集视频的开篇钩子
   - 【人物卡】：更新能力/装备/状态
   - `current_block + 1`：递增块编号
   - 待处理队列：勾选已完成的块

2. **停止并等待**：完成一个块后，停止执行，等待用户确认后再处理下一个块


---

## 质量自检标准 (QC) [v5.0 更新]

生成后请快速扫读：

### 基础检查
1. **像人话吗？** (有没有"未曾"、"随即"这种词？有就改掉)
2. **看得累吗？** (有没有长难句？有就拆开)

### v5.0 新增检查
3. **情绪起伏够吗？** 
   - 压抑→爆发类型：前70%是否足够憋屈？后30%是否足够爽？
   - 层层递进类型：是否有3-4个递进的小高潮？
   - 转折点是否用了短句+感叹句加强冲击？

4. **金句够吗？**
   - 标准块是否有≥2个金句？
   - 高密度块是否有≥3个金句？
   - 金句是否≤20字？
   - 金句是否均匀分布？

5. **钩子对吗？**
   - 是否使用了预知式剧透钩子？
   - 是否避免了疑问句式？（"接下来会怎样？"这种要删掉）
   - 钩子是否有具体的剧透内容？